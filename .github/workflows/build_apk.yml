name: Build Android APK

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' 


    # 2. Setup Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 3. Setup Flutter (REQUIRED for Flet 0.22.1 builds)
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.6' # Matches the Flet 0.22.x era
        channel: 'stable'

    - name: Install Android NDK
      run: |
        # NDK 25b or 26b are usually safest for Flet 0.22
        sdkmanager "ndk;25.2.9519653"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

    - name: Build APK
      env:
        # These help some C-extensions find the right cross-compiler
        CC: aarch64-linux-android24-clang
        CXX: aarch64-linux-android24-clang++
      run: |
        # We add --no-cache-dir to ensure we don't grab a half-baked build
        # and we explicitly tell flet to include these packages
        flet build apk --verbose \
          --include-packages flet_audio_recorder,numpy,opencv-python-headless